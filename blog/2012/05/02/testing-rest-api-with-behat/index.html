
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Testing REST API with Behat - Keith Loy</title>
  <meta name="author" content="Keith Loy">

  
  <meta name="description" content="Today I&#8217;ll cover testing REST APIs with Behat. I will be using
Laravel to build our sample REST API. Also, I will be using guzzle
as the REST &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://kloy.github.com/blog/2012/05/02/testing-rest-api-with-behat/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Keith Loy" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Keith Loy</a></h1>
  
    <h2>Simplifying the Web</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:kloy.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Testing REST API With Behat</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-05-02T08:17:00-05:00" pubdate data-updated="true">May 2<span>nd</span>, 2012</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Today I&#8217;ll cover testing REST APIs with <a href="http://behat.org/">Behat</a>. I will be using
<a href="http://laravel.com/">Laravel</a> to build our sample REST API. Also, I will be using guzzle
as the REST client. This proves to be a much simpler method of testing the REST API then
writing a driver or extending mink.</p>

<p>This is more of an advanced tutorial so I&#8217;m going to skip over some of the more basic
setup steps or just briefly mention them. If you need additional setup help just ask in
the comments.</p>

<p>An example containing all of the code needed can be found on github at
<a href="https://github.com/kloy/behat-rest-testing">behat-rest-testing</a>.</p>

<!--more-->


<h3>Getting Started</h3>

<p>Before we start we need to git a fresh copy of <a href="http://laravel.com/">Laravel</a>.</p>

<pre><code># Clone laravel repo
git://github.com/laravel/laravel.git
</code></pre>

<p>You will also need to setup a vhost with a local url of <strong>foo.local</strong> that points to the <strong>public</strong>
dir of the laravel project.</p>

<p>Now that we have a fresh project go ahead and cd into it and grab composer.</p>

<pre><code># Install composer
curl -s http://getcomposer.org/installer | php
</code></pre>

<p>Awesome, now we are ready to setup our <strong>composer.json</strong> with the necessary
dependencies. Go ahead and create <strong>composer.json</strong> at the top of our project and add the
following to it.</p>

<figure class='code'><figcaption><span>Composer.json (composer.json)</span> <a href='/downloads/code/testing-rest-api-with-behat/composer.json'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="err">//</span> <span class="err">composer.json</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;require&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;behat/behat&quot;</span><span class="p">:</span> <span class="s2">&quot;2.3.*&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;guzzle/guzzle&quot;</span><span class="p">:</span> <span class="s2">&quot;2.4.*&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;config&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;bin-dir&quot;</span><span class="p">:</span> <span class="s2">&quot;bin/&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that we have our dependencies listed go ahead and install them.</p>

<pre><code># install composer
php composer.phar install
</code></pre>

<p>You should now have a few libraries in <strong>vendor/</strong> and an executable for <strong>behat</strong> in
<strong>bin/</strong>. We can now go ahead and initialize behat and get to working on our custom REST
Context.</p>

<pre><code># initialize behat
bin/behat --init
</code></pre>

<h3>Writing our REST Context</h3>

<p>Create a file in <strong>features/bootstrap/</strong> called <strong>RestContext.php</strong>. Add the following to
<strong>RestContext.php</strong>&#8230;</p>

<figure class='code'><figcaption><span>features/bootstrap/RestContext.php (RestContext.php)</span> <a href='/downloads/code/testing-rest-api-with-behat/RestContext.php'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="k">use</span> <span class="nx">Behat\Behat\Context\BehatContext</span><span class="p">;</span>
</span><span class='line'><span class="k">use</span> <span class="nx">Symfony\Component\Yaml\Yaml</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="sd">/**</span>
</span><span class='line'><span class="sd"> * Rest context.</span>
</span><span class='line'><span class="sd"> */</span>
</span><span class='line'><span class="k">class</span> <span class="nc">RestContext</span> <span class="k">extends</span> <span class="nx">BehatContext</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="nv">$_restObject</span>        <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'>    <span class="k">private</span> <span class="nv">$_restObjectType</span>    <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'>    <span class="k">private</span> <span class="nv">$_restObjectMethod</span>  <span class="o">=</span> <span class="s1">&#39;get&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">private</span> <span class="nv">$_client</span>            <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'>    <span class="k">private</span> <span class="nv">$_response</span>          <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'>    <span class="k">private</span> <span class="nv">$_requestUrl</span>        <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="nv">$_parameters</span>           <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * Initializes context.</span>
</span><span class='line'><span class="sd">     * Every scenario gets it&#39;s own context object.</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="k">array</span> <span class="nv">$parameters</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Initialize your context here</span>
</span><span class='line'>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_restObject</span>  <span class="o">=</span> <span class="k">new</span> <span class="k">stdClass</span><span class="p">();</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_client</span>      <span class="o">=</span> <span class="k">new</span> <span class="nx">Guzzle\Service\Client</span><span class="p">();</span>
</span><span class='line'>      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_parameters</span> <span class="o">=</span> <span class="nv">$parameters</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">getParameter</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_parameters</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nx">\Exception</span><span class="p">(</span><span class="s1">&#39;Parameters not loaded!&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>            <span class="nv">$parameters</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_parameters</span><span class="p">;</span>
</span><span class='line'>            <span class="k">return</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$parameters</span><span class="p">[</span><span class="nv">$name</span><span class="p">]))</span> <span class="o">?</span> <span class="nv">$parameters</span><span class="p">[</span><span class="nv">$name</span><span class="p">]</span> <span class="o">:</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>     <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * @Given /^that I want to make a new &quot;([^&quot;]*)&quot;$/</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">thatIWantToMakeANew</span><span class="p">(</span><span class="nv">$objectType</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_restObjectType</span>   <span class="o">=</span> <span class="nx">ucwords</span><span class="p">(</span><span class="nx">strtolower</span><span class="p">(</span><span class="nv">$objectType</span><span class="p">));</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_restObjectMethod</span> <span class="o">=</span> <span class="s1">&#39;post&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>     <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * @Given /^that I want to find a &quot;([^&quot;]*)&quot;$/</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">thatIWantToFindA</span><span class="p">(</span><span class="nv">$objectType</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_restObjectType</span>   <span class="o">=</span> <span class="nx">ucwords</span><span class="p">(</span><span class="nx">strtolower</span><span class="p">(</span><span class="nv">$objectType</span><span class="p">));</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_restObjectMethod</span> <span class="o">=</span> <span class="s1">&#39;get&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * @Given /^that I want to delete a &quot;([^&quot;]*)&quot;$/</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">thatIWantToDeleteA</span><span class="p">(</span><span class="nv">$objectType</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_restObjectType</span>   <span class="o">=</span> <span class="nx">ucwords</span><span class="p">(</span><span class="nx">strtolower</span><span class="p">(</span><span class="nv">$objectType</span><span class="p">));</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_restObjectMethod</span> <span class="o">=</span> <span class="s1">&#39;delete&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * @Given /^that its &quot;([^&quot;]*)&quot; is &quot;([^&quot;]*)&quot;$/</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">thatTheItsIs</span><span class="p">(</span><span class="nv">$propertyName</span><span class="p">,</span> <span class="nv">$propertyValue</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_restObject</span><span class="o">-&gt;</span><span class="nv">$propertyName</span> <span class="o">=</span> <span class="nv">$propertyValue</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * @When /^I request &quot;([^&quot;]*)&quot;$/</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">iRequest</span><span class="p">(</span><span class="nv">$pageUrl</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$baseUrl</span>          <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getParameter</span><span class="p">(</span><span class="s1">&#39;base_url&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_requestUrl</span>  <span class="o">=</span> <span class="nv">$baseUrl</span><span class="o">.</span><span class="nv">$pageUrl</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">switch</span> <span class="p">(</span><span class="nx">strtoupper</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_restObjectMethod</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">case</span> <span class="s1">&#39;GET&#39;</span><span class="o">:</span>
</span><span class='line'>                <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_client</span>
</span><span class='line'>                    <span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_requestUrl</span><span class="o">.</span><span class="s1">&#39;?&#39;</span><span class="o">.</span><span class="nb">http_build_str</span><span class="p">((</span><span class="k">array</span><span class="p">)</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_restObject</span><span class="p">))</span>
</span><span class='line'>                    <span class="o">-&gt;</span><span class="na">send</span><span class="p">();</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>            <span class="k">case</span> <span class="s1">&#39;POST&#39;</span><span class="o">:</span>
</span><span class='line'>                <span class="nv">$postFields</span> <span class="o">=</span> <span class="p">(</span><span class="k">array</span><span class="p">)</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_restObject</span><span class="p">;</span>
</span><span class='line'>                <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_client</span>
</span><span class='line'>                    <span class="o">-&gt;</span><span class="na">post</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_requestUrl</span><span class="p">,</span><span class="k">null</span><span class="p">,</span><span class="nv">$postFields</span><span class="p">)</span>
</span><span class='line'>                    <span class="o">-&gt;</span><span class="na">send</span><span class="p">();</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>            <span class="k">case</span> <span class="s1">&#39;DELETE&#39;</span><span class="o">:</span>
</span><span class='line'>              <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_client</span>
</span><span class='line'>                    <span class="o">-&gt;</span><span class="na">delete</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_requestUrl</span><span class="o">.</span><span class="s1">&#39;?&#39;</span><span class="o">.</span><span class="nb">http_build_str</span><span class="p">((</span><span class="k">array</span><span class="p">)</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_restObject</span><span class="p">))</span>
</span><span class='line'>                    <span class="o">-&gt;</span><span class="na">send</span><span class="p">();</span>
</span><span class='line'>              <span class="k">break</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_response</span> <span class="o">=</span> <span class="nv">$response</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * @Then /^the response is JSON$/</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">theResponseIsJson</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$data</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_response</span><span class="o">-&gt;</span><span class="na">getBody</span><span class="p">(</span><span class="k">true</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s2">&quot;Response was not JSON</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_response</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * @Given /^the response has a &quot;([^&quot;]*)&quot; property$/</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">theResponseHasAProperty</span><span class="p">(</span><span class="nv">$propertyName</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$data</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_response</span><span class="o">-&gt;</span><span class="na">getBody</span><span class="p">(</span><span class="k">true</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$data</span><span class="o">-&gt;</span><span class="nv">$propertyName</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s2">&quot;Property &#39;&quot;</span><span class="o">.</span><span class="nv">$propertyName</span><span class="o">.</span><span class="s2">&quot;&#39; is not set!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s2">&quot;Response was not JSON</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_response</span><span class="o">-&gt;</span><span class="na">getBody</span><span class="p">(</span><span class="k">true</span><span class="p">));</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * @Then /^the &quot;([^&quot;]*)&quot; property equals &quot;([^&quot;]*)&quot;$/</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">thePropertyEquals</span><span class="p">(</span><span class="nv">$propertyName</span><span class="p">,</span> <span class="nv">$propertyValue</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$data</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_response</span><span class="o">-&gt;</span><span class="na">getBody</span><span class="p">(</span><span class="k">true</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$data</span><span class="o">-&gt;</span><span class="nv">$propertyName</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s2">&quot;Property &#39;&quot;</span><span class="o">.</span><span class="nv">$propertyName</span><span class="o">.</span><span class="s2">&quot;&#39; is not set!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nv">$data</span><span class="o">-&gt;</span><span class="nv">$propertyName</span> <span class="o">!==</span> <span class="nv">$propertyValue</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="k">throw</span> <span class="k">new</span> <span class="nx">\Exception</span><span class="p">(</span><span class="s1">&#39;Property value mismatch! (given: &#39;</span><span class="o">.</span><span class="nv">$propertyValue</span><span class="o">.</span><span class="s1">&#39;, match: &#39;</span><span class="o">.</span><span class="nv">$data</span><span class="o">-&gt;</span><span class="nv">$propertyName</span><span class="o">.</span><span class="s1">&#39;)&#39;</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s2">&quot;Response was not JSON</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_response</span><span class="o">-&gt;</span><span class="na">getBody</span><span class="p">(</span><span class="k">true</span><span class="p">));</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * @Given /^the type of the &quot;([^&quot;]*)&quot; property is ([^&quot;]*)$/</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">theTypeOfThePropertyIsNumeric</span><span class="p">(</span><span class="nv">$propertyName</span><span class="p">,</span><span class="nv">$typeString</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$data</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_response</span><span class="o">-&gt;</span><span class="na">getBody</span><span class="p">(</span><span class="k">true</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$data</span><span class="o">-&gt;</span><span class="nv">$propertyName</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s2">&quot;Property &#39;&quot;</span><span class="o">.</span><span class="nv">$propertyName</span><span class="o">.</span><span class="s2">&quot;&#39; is not set!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="c1">// check our type</span>
</span><span class='line'>            <span class="k">switch</span> <span class="p">(</span><span class="nx">strtolower</span><span class="p">(</span><span class="nv">$typeString</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">case</span> <span class="s1">&#39;numeric&#39;</span><span class="o">:</span>
</span><span class='line'>                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_numeric</span><span class="p">(</span><span class="nv">$data</span><span class="o">-&gt;</span><span class="nv">$propertyName</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                        <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s2">&quot;Property &#39;&quot;</span><span class="o">.</span><span class="nv">$propertyName</span><span class="o">.</span><span class="s2">&quot;&#39; is not of the correct type: &quot;</span><span class="o">.</span><span class="nv">$theTypeOfThePropertyIsNumeric</span><span class="o">.</span><span class="s2">&quot;!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                    <span class="k">break</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s2">&quot;Response was not JSON</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_response</span><span class="o">-&gt;</span><span class="na">getBody</span><span class="p">(</span><span class="k">true</span><span class="p">));</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * @Then /^the response status code should be (\d+)$/</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">theResponseStatusCodeShouldBe</span><span class="p">(</span><span class="nv">$httpStatus</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">((</span><span class="nx">string</span><span class="p">)</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_response</span><span class="o">-&gt;</span><span class="na">getStatusCode</span><span class="p">()</span> <span class="o">!==</span> <span class="nv">$httpStatus</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">throw</span> <span class="k">new</span> <span class="nx">\Exception</span><span class="p">(</span><span class="s1">&#39;HTTP code does not match &#39;</span><span class="o">.</span><span class="nv">$httpStatus</span><span class="o">.</span>
</span><span class='line'>              <span class="s1">&#39; (actual: &#39;</span><span class="o">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_response</span><span class="o">-&gt;</span><span class="na">getStatusCode</span><span class="p">()</span><span class="o">.</span><span class="s1">&#39;)&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>     <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * @Then /^echo last response$/</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">echoLastResponse</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">printDebug</span><span class="p">(</span>
</span><span class='line'>            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_requestUrl</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span>
</span><span class='line'>            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_response</span>
</span><span class='line'>        <span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>So that was a bit of code. I&#8217;ll sort of explain it in a moment after we get it working. In
order for these steps to work we need to add <strong>RestContext</strong> as a sub context to <strong>FeatureContext</strong>.
Let&#8217;s do that.</p>

<figure class='code'><figcaption><span>features/bootstrap/FeatureContext.php (FeatureContext.php)</span> <a href='/downloads/code/testing-rest-api-with-behat/FeatureContext.php'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>
</span><span class='line'><span class="k">use</span> <span class="nx">Behat\Behat\Context\ClosuredContextInterface</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">Behat\Behat\Context\TranslatedContextInterface</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">Behat\Behat\Context\BehatContext</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">Behat\Behat\Exception\PendingException</span><span class="p">;</span>
</span><span class='line'><span class="k">use</span> <span class="nx">Behat\Gherkin\Node\PyStringNode</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">Behat\Gherkin\Node\TableNode</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">// Require 3rd-party libraries here:</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">//   require_once &#39;PHPUnit/Autoload.php&#39;;</span>
</span><span class='line'><span class="c1">//   require_once &#39;PHPUnit/Framework/Assert/Functions.php&#39;;</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="k">require_once</span> <span class="s1">&#39;RestContext.php&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="sd">/**</span>
</span><span class='line'><span class="sd"> * Features context.</span>
</span><span class='line'><span class="sd"> */</span>
</span><span class='line'><span class="k">class</span> <span class="nc">FeatureContext</span> <span class="k">extends</span> <span class="nx">BehatContext</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * Initializes context.</span>
</span><span class='line'><span class="sd">     * Every scenario gets it&#39;s own context object.</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @param   array   $parameters     context parameters (set them up through behat.yml)</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="k">array</span> <span class="nv">$parameters</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Initialize your context here</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">useContext</span><span class="p">(</span><span class="s1">&#39;RestContext&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nx">RestContext</span><span class="p">(</span><span class="nv">$parameters</span><span class="p">));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>So what we did is require our RestContext.php file and instantiate it in
<code>$this-&gt;useContext('RestContext', new RestContext($parameters));</code>. Now when you type
<strong>bin/behat -dl</strong> you should see a list commands that look like&#8230;</p>

<pre><code># output from cli
Given /^that I want to make a new "([^"]*)"$/
Given /^that I want to find a "([^"]*)"$/
Given /^that I want to delete a "([^"]*)"$/
Given /^that its "([^"]*)" is "([^"]*)"$/
When /^I request "([^"]*)"$/
Then /^the response is JSON$/
Given /^the response has a "([^"]*)" property$/
Then /^the "([^"]*)" property equals "([^"]*)"$/
Given /^the type of the "([^"]*)" property is ([^"]*)$/
Then /^the response status code should be (\d+)$/
Then /^echo last response$/
</code></pre>

<p>All of these steps are coming from our RestContext class.</p>

<h3>Adding behat.yml</h3>

<p>We need a config file for behat specifying where our api is. Create the file <strong>behat.yml</strong>
at the top dir of your project.</p>

<figure class='code'><figcaption><span>behat.yml  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">default</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">context</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="err">    </span><span class="l-Scalar-Plain">parameters</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="err">        </span><span class="l-Scalar-Plain">base_url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://foo.local</span>
</span></code></pre></td></tr></table></div></figure>


<p>The property <strong>base_url</strong> is where we specified the location of our api.</p>

<h3>Writing our features</h3>

<p>Now that all the ground work is in place, let&#8217;s write a few features for testing. Go ahead
and create a file <strong>features/user.feature</strong> and add the following to it.</p>

<figure class='code'><figcaption><span>features/user.feature (user.feature)</span> <a href='/downloads/code/testing-rest-api-with-behat/user.feature'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="c1"># features/user.feature</span>
</span><span class='line'><span class="err">    </span><span class="l-Scalar-Plain">Feature</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Testing the RESTfulness of the Index controller</span>
</span><span class='line'>    <span class="l-Scalar-Plain">Let&#39;s see how RESTish this is</span>
</span><span class='line'>
</span><span class='line'>    <span class="l-Scalar-Plain">Scenario</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Creating a new User</span>
</span><span class='line'>        <span class="l-Scalar-Plain">Given that I want to make a new &quot;User&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">And that its &quot;name&quot; is &quot;Chris&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">When I request &quot;/user&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">Then the response is JSON</span>
</span><span class='line'>        <span class="l-Scalar-Plain">And the response has a &quot;userId&quot; property</span>
</span><span class='line'>        <span class="l-Scalar-Plain">And the type of the &quot;userId&quot; property is numeric</span>
</span><span class='line'>        <span class="l-Scalar-Plain">Then the response status code should be 200</span>
</span><span class='line'>
</span><span class='line'>    <span class="l-Scalar-Plain">Scenario</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Finding a User</span>
</span><span class='line'>        <span class="l-Scalar-Plain">Given that I want to find a &quot;User&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">And that its &quot;name&quot; is &quot;Chris&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">When I request &quot;/user&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">Then the &quot;name&quot; property equals &quot;Chris&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="l-Scalar-Plain">Scenario</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Deleting a User</span>
</span><span class='line'>        <span class="l-Scalar-Plain">Given that I want to delete a &quot;User&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">And that its &quot;name&quot; is &quot;Chris&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">When I request &quot;/user&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">Then the &quot;status&quot; property equals &quot;true&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that we have our feature let&#8217;s run it with <strong>bin/behat features/user.feature</strong>. You should
get errors with a large amount of html spit back out at you. This is because Laravel
does not have a route/api for what is being tested. We will create that in the next step.</p>

<h3>Creating our API</h3>

<p>Our API is for demonstration purposes only, so I&#8217;m going to go ahead and provide a quick
stub API that will pass our expectations. Enter the following code into <strong>application/routes.php</strong>.</p>

<figure class='code'><figcaption><span>application/routes.php (routes.php)</span> <a href='/downloads/code/testing-rest-api-with-behat/routes.php'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="c1">// in application/routes.php</span>
</span><span class='line'><span class="nx">Route</span><span class="o">::</span><span class="na">post</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;userId&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">Response</span><span class="o">::</span><span class="na">make</span><span class="p">(</span><span class="nb">json_encode</span><span class="p">(</span><span class="nv">$data</span><span class="p">),</span> <span class="mi">200</span><span class="p">,</span>
</span><span class='line'>        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;application/json&#39;</span><span class="p">));</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">Route</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Chris&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">Response</span><span class="o">::</span><span class="na">make</span><span class="p">(</span><span class="nb">json_encode</span><span class="p">(</span><span class="nv">$data</span><span class="p">),</span> <span class="mi">200</span><span class="p">,</span>
</span><span class='line'>        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;application/json&#39;</span><span class="p">));</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">Route</span><span class="o">::</span><span class="na">delete</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;status&#39;</span> <span class="o">=&gt;</span> <span class="s2">&quot;true&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">Response</span><span class="o">::</span><span class="na">make</span><span class="p">(</span><span class="nb">json_encode</span><span class="p">(</span><span class="nv">$data</span><span class="p">),</span> <span class="mi">200</span><span class="p">,</span>
</span><span class='line'>        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;application/json&#39;</span><span class="p">));</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>Go ahead and run <strong>bin/behat features/user.feature</strong> and you should get all green with a
message like so&#8230;</p>

<pre><code>Feature: Testing the RESTfulness of the Index controller
Let's see how RESTish this is

  Scenario: Creating a new User                      # features/user.feature:4
    Given that I want to make a new "User"           # RestContext::thatIWantToMakeANew()
    And that its "name" is "Chris"                   # RestContext::thatTheItsIs()
    When I request "/user"                           # RestContext::iRequest()
    Then the response is JSON                        # RestContext::theResponseIsJson()
    And the response has a "userId" property         # RestContext::theResponseHasAProperty()
    And the type of the "userId" property is numeric # RestContext::theTypeOfThePropertyIsNumeric()
    Then the response status code should be 200      # RestContext::theResponseStatusCodeShouldBe()

  Scenario: Finding a User                           # features/user.feature:13
    Given that I want to find a "User"               # RestContext::thatIWantToFindA()
    And that its "name" is "Chris"                   # RestContext::thatTheItsIs()
    When I request "/user"                           # RestContext::iRequest()
    Then the "name" property equals "Chris"          # RestContext::thePropertyEquals()

  Scenario: Deleting a User                          # features/user.feature:19
    Given that I want to delete a "User"             # RestContext::thatIWantToDeleteA()
    And that its "name" is "Chris"                   # RestContext::thatTheItsIs()
    When I request "/user"                           # RestContext::iRequest()
    Then the "status" property equals "true"         # RestContext::thePropertyEquals()

3 scenarios (3 passed)
15 steps (15 passed)
0m0.131s
</code></pre>

<h3>Closing notes</h3>

<p>Now that we have a REST API in place and a Rest Context for behat you should be able to
see how we could test any REST API. If you need more steps to use when testing your REST
APIs just add them to the RestContext class and they will then be available to use in your
Gherkin features.</p>

<h3>Credits</h3>

<p>This article was heavily inspired by
<a href="http://blog.phpdeveloper.org/?p=456">behat + fuelphp = restful testing happiness</a> written
by Chris Cornutt. The RestContext class is just a refactor of his FeatureContextRest class
to allow using it as a sub context which I feel makes it more natural to use and easier to
reuse in projects. I also wanted to make a point that principals apply to any REST API and
not just one built with FuelPHP.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Keith Loy</span></span>

      








  


<time datetime="2012-05-02T08:17:00-05:00" pubdate data-updated="true">May 2<span>nd</span>, 2012</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://kloy.github.com/blog/2012/05/02/testing-rest-api-with-behat/" data-via="guynamedkeith" data-counturl="http://kloy.github.com/blog/2012/05/02/testing-rest-api-with-behat/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="small"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2012/04/11/yaml-config-files-in-laravel/" title="Previous Post: Yaml config files in Laravel">&laquo; Yaml config files in Laravel</a>
      
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/05/02/testing-rest-api-with-behat/">Testing REST API with Behat</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/04/11/yaml-config-files-in-laravel/">Yaml config files in Laravel</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/04/10/laravel-as-a-git-submodule/">Laravel as a git submodule</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/04/10/composer-with-laravel/">Composer with Laravel</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/02/12/testing-suite-for-jruby-on-rails-with-rspec/">Testing Suite for jRuby on Rails with RSpec</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/kloy">@kloy</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'kloy',
            count: 4,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("guynamedkeith", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/guynamedkeith" class="twitter-follow-button" data-show-count="false">Follow @guynamedkeith</a>
  
</section>


<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/ckeithloy@gmail.com?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Keith Loy -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
